<div class="gallery-box border-4 border-neutral-300 dark:border-neutral-600 rounded-lg p-6 my-4">
  {{ if .Get "title" }}
  <h3 class="gallery-title text-xl font-bold mb-1">{{ .Get "title" }}</h3>
  {{ end }}

  {{ if or (.Get "location") (.Get "date") }}
  <p class="gallery-location text-sm mb-2">
    {{ if .Get "location" }}{{ .Get "location" }}{{ end }}
    {{ if and (.Get "location") (.Get "date") }}, {{ end }}
    {{ if .Get "date" }}{{ .Get "date" }}{{ end }}
  </p>
  {{ end }}

  {{ if .Get "description" }}
  <p class="gallery-description text-sm mb-2">{{ .Get "description" }}</p>
  {{ end }}

  {{ if .Get "credits" }}
  <p class="gallery-credits text-xs italic mb-4">{{ .Get "credits" }}</p>
  {{ end }}

  <div class="image-gallery">
    {{ $imagesParam := .Get "images" | default "" }}
    {{ $vimeosParam := .Get "vimeos" | default "" }}
    {{ $youtubesParam := .Get "youtubes" | default "" }}
    {{ $orientationsParam := .Get "orientations" | default "" }}
    {{ $captionsParam := .Get "captions" | default "" }}

    {{ $images := cond (ne $imagesParam "") (split $imagesParam ",") (slice) }}
    {{ $vimeos := cond (ne $vimeosParam "") (split $vimeosParam ",") (slice) }}
    {{ $youtubes := cond (ne $youtubesParam "") (split $youtubesParam ",") (slice) }}
    {{ $orientations := cond (ne $orientationsParam "") (split $orientationsParam ",") (slice) }}
    {{ $captions := cond (ne $captionsParam "") (split $captionsParam "|") (slice) }}

    {{ $maxLen := len $images }}
    {{ if gt (len $vimeos) $maxLen }}{{ $maxLen = len $vimeos }}{{ end }}
    {{ if gt (len $youtubes) $maxLen }}{{ $maxLen = len $youtubes }}{{ end }}

    {{ range $index := seq 0 (sub $maxLen 1) }}
      {{ $image := "" }}
      {{ if lt $index (len $images) }}{{ $image = trim (index $images $index) " " }}{{ end }}

      {{ $vimeoID := "" }}
      {{ if lt $index (len $vimeos) }}{{ $vimeoID = trim (index $vimeos $index) " " }}{{ end }}

      {{ $youtubeID := "" }}
      {{ if lt $index (len $youtubes) }}{{ $youtubeID = trim (index $youtubes $index) " " }}{{ end }}

      {{ $orientation := "landscape" }}
      {{ if lt $index (len $orientations) }}{{ $orientation = trim (index $orientations $index) " " }}{{ end }}

      {{ $caption := "" }}
      {{ if lt $index (len $captions) }}{{ $caption = index $captions $index }}{{ end }}

      <div class="gallery-item">
        {{ if ne $vimeoID "" }}
          <div class="video-embed{{ if eq $orientation "portrait" }} portrait{{ end }}">
            <iframe src="https://player.vimeo.com/video/{{ $vimeoID }}"
                    frameborder="0"
                    allow="autoplay; fullscreen; picture-in-picture"
                    allowfullscreen>
            </iframe>
          </div>
        {{ else if ne $youtubeID "" }}
          <div class="video-embed{{ if eq $orientation "portrait" }} portrait{{ end }}">
            <iframe src="https://www.youtube.com/embed/{{ $youtubeID }}"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
            </iframe>
          </div>
        {{ else if ne $image "" }}
          {{ if or (strings.HasSuffix $image ".mp4") (strings.HasSuffix $image ".mov") }}
            <div class="video-embed{{ if eq $orientation "portrait" }} portrait{{ end }}">
              <video controls preload="metadata">
                <source src="{{ $image }}" type="video/mp4">
              </video>
            </div>
          {{ else }}
            <img src="{{ $image }}" alt="" loading="lazy" decoding="async">
          {{ end }}
        {{ end }}

        {{ if ne $caption "" }}
        <p class="image-caption">{{ $caption }}</p>
        {{ end }}
      </div>
    {{ end }}
  </div>
</div>

<style>
  .gallery-title {
    font-size: 1.25rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
  }

  .gallery-location {
    color: rgb(var(--color-primary-600));
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }

  .dark .gallery-location {
    color: rgb(var(--color-primary-400));
  }

  .gallery-description {
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }

  .gallery-credits {
    font-size: 0.75rem;
    font-style: italic;
    margin-bottom: 1rem;
    opacity: 0.7;
  }

  .dark .gallery-title,
  .dark .gallery-description,
  .dark .gallery-credits {
    text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.9);
    color: rgba(255, 255, 255, 0.95);
  }

  .dark .gallery-location {
    text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.9);
  }

  body:has(.project-bg-overlay) .gallery-title,
  body:has(.project-bg-overlay) .gallery-description,
  body:has(.project-bg-overlay) .gallery-credits {
    text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.9);
    color: white;
  }

  body:has(.project-bg-overlay) .gallery-location {
    text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.9);
    color: rgb(var(--color-primary-400));
  }

  .image-gallery {
    display: flex;
    overflow-x: auto;
    gap: 1rem;
    padding: 0rem 0 1rem 0;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }

  .gallery-item {
    flex-shrink: 0;
    scroll-snap-align: start;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .image-gallery img {
    height: 600px;
    min-width: 450px;
    object-fit: cover;
    border-radius: 8px;
    display: block;
    align-self: flex-start;
  }

  /* Desktop landscape videos (16:9) */
  .video-embed {
    position: relative;
    width: 1067px;
    aspect-ratio: 16/9;
    border-radius: 8px;
    overflow: hidden;
    background: black;
    display: block;
    flex-shrink: 0;
  }

  .video-embed iframe,
  .video-embed video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  /* Portrait videos (9:16) */
  .video-embed.portrait {
    width: 338px;
    aspect-ratio: 9/16;
  }

  .image-caption {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: rgb(var(--color-neutral-600));
    max-width: 450px;
  }

  .video-embed ~ .image-caption {
    max-width: 1067px;
  }

  .video-embed.portrait ~ .image-caption {
    max-width: 338px;
  }

  .dark .image-caption {
    color: rgb(var(--color-neutral-400));
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .image-gallery img {
      height: auto;
      min-width: 85vw;
      max-width: 85vw;
    }

    .video-embed {
      width: 85vw;
      aspect-ratio: 16/9;
    }

    .video-embed.portrait {
      width: 60vw;
      aspect-ratio: 9/16;
    }

    .image-caption {
      max-width: 85vw;
    }
  }

  @media (max-width: 480px) {
    .image-gallery img {
      min-width: 90vw;
      max-width: 90vw;
    }

    .video-embed {
      width: 90vw;
    }

    .video-embed.portrait {
      width: 65vw;
    }

    .image-caption {
      max-width: 90vw;
    }
  }

  .image-gallery::-webkit-scrollbar {
    height: 8px;
  }

  .image-gallery::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.1);
    border-radius: 10px;
  }

  .image-gallery::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
  }
</style>
