<div id="floating-toc" class="floating-toc">
  <button id="toc-toggle" class="toc-toggle">
    <span id="toc-icon">☰</span> Contents
  </button>
  <div id="toc-content" class="toc-content">
    <h3 class="text-sm font-bold mb-3 text-neutral-900 dark:text-neutral">On this page</h3>
    <nav id="toc-nav">
      {{ if eq .Page.Type "projects" }}
      <!-- Placeholder - will be populated by JavaScript -->
      <ul id="toc-list"></ul>
      {{ else }}
      <!-- Auto-generated TOC for blog posts -->
      {{ .Page.TableOfContents }}
      {{ end }}
    </nav>
  </div>
</div>

<style>
.floating-toc {
  position: fixed;
  right: 2rem;
  top: 120px;
  width: 280px;
  z-index: 0;
  background: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(8px);
  border: 2px solid rgb(var(--color-primary-400));
  border-radius: 0.5rem;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.dark .floating-toc {
  background: rgb(var(--color-neutral-800));
  border-color: rgb(var(--color-primary-600));
}

.toc-toggle {
  width: 100%;
  padding: 0.75rem 1rem;
  background: rgba(var(--color-primary-600), 0.3);
  color: white;
  border: none;
  border-radius: 0.5rem 0.5rem 0 0;
  cursor: pointer;
  font-weight: 600;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: background 0.2s;
}

.toc-toggle:hover {
  background: rgb(var(--color-primary-700));
}

.toc-content {
  max-height: 70vh;
  overflow-y: auto;
  padding: 1rem;
  display: block;
}

.toc-content.hidden {
  display: none;
}

.floating-toc nav ul {
  list-style: none;
  padding-left: 0;
  margin: 0;
}

.floating-toc nav ul ul {
  padding-left: 1rem;
  margin-top: 0.25rem;
}

.floating-toc nav li {
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
}

.floating-toc nav a {
  color: rgb(var(--color-neutral-700));
  text-decoration: none;
  transition: color 0.2s;
  display: block;
}

.floating-toc nav a:hover {
  color: rgb(var(--color-primary-600));
}

.dark .floating-toc nav a {
  color: rgb(var(--color-neutral-300));
}

.dark .floating-toc nav a:hover {
  color: rgb(var(--color-primary-400));
}

@media (min-width: 1280px) and (max-width: 1600px) {
  .floating-toc {
    right: 1rem;
  }
}

@media (min-width: 1600px) {
  .floating-toc {
    right: calc((100vw - 1200px) / 2 - 320px);
  }
}

@media (max-width: 1280px) {
  .floating-toc {
    display: none;
  }
}

.toc-content::-webkit-scrollbar {
  width: 6px;
}

.toc-content::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.05);
}

.toc-content::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.4);
  border-radius: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle functionality
  const toggle = document.getElementById('toc-toggle');
  const content = document.getElementById('toc-content');
  const icon = document.getElementById('toc-icon');

  if (toggle && content && icon) {
    toggle.addEventListener('click', function() {
      content.classList.toggle('hidden');
      icon.textContent = content.classList.contains('hidden') ? '☰' : '✕';
    });
  }

  // Build TOC for project pages
  const tocList = document.getElementById('toc-list');
  if (tocList) {
    const contentArea = document.querySelector('.project-content, article, main');
    if (!contentArea) return;

    // Define predefined sections to look for
    const predefinedSections = [
      { id: 'about', label: 'About' },
      { id: 'process', label: 'Process' },
      { id: 'documentation', label: 'Documentation' },
      { id: 'press', label: 'Press' },
      { id: 'credits', label: 'Credits' },
      { id: 'related', label: 'Related' }
    ];

    // First, add predefined sections if they exist
    predefinedSections.forEach(function(section) {
      const element = document.getElementById(section.id);
      if (element) {
        const li = document.createElement('li');
        li.id = section.id + '-item';
        const link = document.createElement('a');
        link.href = '#' + section.id;
        link.textContent = section.label;
        li.appendChild(link);
        tocList.appendChild(li);
      }
    });

    // Then, find all other h2 headings that aren't already in predefined sections
    const headings = contentArea.querySelectorAll('h2');
    const predefinedIds = predefinedSections.map(s => s.id);

    headings.forEach(function(heading) {
      // Create or get ID for the heading
      if (!heading.id) {
        heading.id = heading.textContent.toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
      }

      // Skip if this heading is already in predefined sections
      if (predefinedIds.includes(heading.id)) {
        return;
      }

      // Add this heading to TOC
      const li = document.createElement('li');
      const link = document.createElement('a');
      link.href = '#' + heading.id;
      link.textContent = heading.textContent;
      li.appendChild(link);
      tocList.appendChild(li);
    });

    // Handle galleries under Documentation
    const galleries = document.querySelectorAll('.gallery-box h3');
    const documentationItem = document.getElementById('documentation-item');

    if (galleries.length > 0 && documentationItem) {
      const submenu = document.createElement('ul');
      galleries.forEach(function(gallery, index) {
        const title = gallery.textContent;
        const anchor = 'gallery-' + index;
        gallery.id = anchor;

        const li = document.createElement('li');
        const link = document.createElement('a');
        link.href = '#' + anchor;
        link.textContent = title;
        li.appendChild(link);
        submenu.appendChild(li);
      });

      documentationItem.appendChild(submenu);
    }
  }
});
</script>
